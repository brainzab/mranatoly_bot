# Настройка Google Drive API для экспорта истории чатов

Для настройки экспорта истории чатов на Google Drive необходимо выполнить следующие шаги:

## 1. Создание проекта в Google Cloud Console

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. В меню навигации выберите "APIs & Services" > "Library"
4. Найдите и включите "Google Drive API"

## 2. Создание сервисного аккаунта

1. В Google Cloud Console перейдите в раздел "IAM & Admin" > "Service Accounts"
2. Нажмите "Create Service Account"
3. Введите имя сервисного аккаунта и описание (например, "Bot Drive Export")
4. Нажмите "Create and Continue"
5. Добавьте необходимые роли для сервисного аккаунта:
   - В поиске ролей найдите и выберите "Drive File Creator" для возможности создавать файлы
   - При необходимости добавьте другие роли
6. Нажмите "Continue", затем "Done"

## 3. Создание ключа сервисного аккаунта

1. В списке сервисных аккаунтов найдите созданный аккаунт и нажмите на его email
2. Перейдите на вкладку "Keys"
3. Нажмите "Add Key" > "Create new key"
4. Выберите формат JSON и нажмите "Create"
5. Файл с ключом будет автоматически загружен на ваш компьютер
6. Переименуйте файл в `credentials.json` и поместите его в корневую директорию проекта (или укажите путь в настройках)

## 4. Создание папки на Google Drive для хранения экспорта

1. Перейдите на [Google Drive](https://drive.google.com/)
2. Создайте новую папку для хранения экспорта (например, "Bot Chat History")
3. Откройте папку и скопируйте ID папки из URL. URL будет выглядеть примерно так:
   ```
   https://drive.google.com/drive/folders/1AbCdEfGhIjKlMnOpQrStUvWxYz
   ```
   где `1AbCdEfGhIjKlMnOpQrStUvWxYz` - это ID папки.

## 5. Предоставление доступа сервисному аккаунту

1. Щелкните правой кнопкой мыши по созданной папке и выберите "Share"
2. В поле "Add people or groups" введите email вашего сервисного аккаунта (его можно найти в файле credentials.json в поле "client_email")
3. Выберите роль "Editor" (Редактор)
4. Снимите флажок "Notify people" и нажмите "Share"

## 6. Настройка переменных окружения для бота

Для включения экспорта в Google Drive добавьте следующие переменные окружения:

```
DRIVE_ENABLED=True
GDRIVE_CREDENTIALS_FILE=credentials.json
GDRIVE_FOLDER_ID=1AbCdEfGhIjKlMnOpQrStUvWxYz  # Укажите ID вашей папки
CHAT_EXPORT_INTERVAL_HOURS=24  # Интервал экспорта в часах
```

## 7. Проверка работы экспорта

После настройки и перезапуска бота вы можете проверить работу экспорта:

1. Вызовите команду `/exportchats` как администратор бота
2. Проверьте логи на наличие ошибок
3. Проверьте папку на Google Drive - там должен появиться файл с экспортом

## Формат экспортируемых данных

Данные экспортируются в JSON-файл в следующем формате:

```json
{
  "export_timestamp": "2023-01-01T00:00:00.000000",
  "total_chats": 2,
  "chats": {
    "-1001234567890": {
      "total_messages": 10,
      "users": {
        "123456789": {
          "message_count": 5
        },
        "987654321": {
          "message_count": 3
        }
      },
      "messages": [
        {
          "id": 1,
          "user_id": 123456789,
          "message_id": 100,
          "role": "user",
          "content": "Привет, бот!",
          "timestamp": "2023-01-01T00:00:00",
          "reset_id": 0,
          "tokens": 0
        }
      ]
    }
  }
}
```

## Автоматический экспорт

Бот автоматически выполняет экспорт данных:

1. По расписанию каждый день в 4:00 утра
2. С интервалом, указанным в настройке `CHAT_EXPORT_INTERVAL_HOURS` (если значение отличается от 24)

## Ограничение доступа

Команда `/exportchats` доступна только для администратора бота, идентификатор которого указан в переменной окружения `ADMIN_CHAT_ID`. 